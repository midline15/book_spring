<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/mypage_layout}">
<th:block layout:fragment="script">
    <script th:inline="javascript">
        function getOrderTotalPrice() {
            var orderTotalPrice = 0;
            $("input[name=cartChkBox]:checked").each(function () {
                var cartItemId = $(this).val();
                var price = $("#price_" + cartItemId).attr("data-price");
                var count = $("#count_" + cartItemId).val();
                orderTotalPrice += price * count;
            });

            $("#orderTotalPrice").html(orderTotalPrice + '원');
        }

        function changeCount(obj) {
            var count = obj.value;
            var cartItemId = obj.id.split('_')[1];
            var price = $("#price_" + cartItemId).data("price");
            var totalPrice = count * price;
            $("#totalPrice_" + cartItemId).html(totalPrice + "원");
            getOrderTotalPrice();
            updateCartItemCount(cartItemId, count);
        }

        function checkAll() {
            if ($("#checkall").prop("checked")) {
                $("input[name=cartChkBox]").prop("checked", true);
            } else {
                $("input[name=cartChkBox]").prop("checked", false);
            }
            getOrderTotalPrice();
        }

        function updateUser(obj) {
            var param = {
                id: obj.dataset.id,
                name: $("[name=name]").val(),
                birth: $("[name=birth]").val(),
                phone: $("[name=phone]").val(),
                address: $("[name=address]").val(),
            }

            $.ajax({
                url: /user/ + param.id,
                type: "PATCH",
                contentType: "application/json",
                data: JSON.stringify(param),
                cache: false,
                success: function (result, status) {
                    alert(result);
                    location.href = "/"
                },
                error: function (jqXHR, status, error) {

                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요');
                        location.href = '/user/login';
                    } else {
                        alert(jqXHR.responseJSON.message);
                    }

                }
            });
        }

        function deleteUser(obj) {
            if (confirm("탈퇴하시겠습니까?")) {
                $.ajax({
                    url: /user/ + obj.dataset.id,
                    type: "DELETE",
                    cache: false,
                    success: function (result, status) {
                        alert(result);
                        location.href = "/logout"
                    },
                    error: function (jqXHR, status, error) {

                        if (jqXHR.status == '401') {
                            alert('로그인 후 이용해주세요');
                            location.href = '/user/login';
                        } else {
                            alert(jqXHR.responseJSON.message);
                        }

                    }
                });
            }
        }

        function orders() {

            var dataList = [];

            $("input[name=cartChkBox]:checked").each(function () {
                let cartItemId = $(this).val();
                dataList.push({
                    id: cartItemId,
                    bookId: $("#bookId_" + cartItemId).val(),
                    price: $("#price_" + cartItemId).attr("data-price"),
                    count: $("#count_" + cartItemId).val()
                });
            });

            var param = JSON.stringify({
                cartBookDtoList: dataList
            });

            $.ajax({
                url: "/cart/order",
                type: "POST",
                contentType: "application/json",
                data: param,
                cache: false,
                success: function (result, status) {
                    alert("주문이 완료 되었습니다.");
                    location.href = '/order';
                },
                error: function (jqXHR, status, error) {

                    if (jqXHR.status == '401') {
                        alert('로그인 후 이용해주세요');
                        location.href = '/members/login';
                    } else {
                        alert(jqXHR.responseJSON.message);
                    }

                }
            });
        }
    </script>
</th:block>
<th:block layout:fragment="content">
    <input type="hidden" name="id" th:value="${user.id}">
    <label>이름 :
        <input name="name" th:value="${user.name}">
    </label>
    <br>
    <label>생년월일 :
        <input name="birth" th:value="${user.birth}" readonly>
    </label>
    <br>
    <label>전화번호 :
        <input name="phone" th:value="${user.phone}">
    </label>
    <br>
    <label>주소 :
        <input name="address" th:value="${user.address}">
    </label>
    <br>
    <button type="button" th:data-id="${user.id}" onclick="updateUser(this)">수 정</button>
    <button type="button" th:data-id="${user.id}" onclick="deleteUser(this)">탈 퇴</button>
</th:block>